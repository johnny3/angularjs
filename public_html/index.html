<!DOCTYPE html>

<html>
    <head>
        <title>Angular formation</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
        <script src="https://code.angularjs.org/1.3.15/angular-route.min.js"></script>
        <script>
            var app = angular.module('myApp', ['ngRoute']);
            app.config(function ($routeProvider) {
                $routeProvider
                        .when('/', {templateUrl: 'partials/home.html', controller: 'PostsCtrl'})
                        .when('/comments/:id', {templateUrl: 'partials/comments.html', controller: 'CommentsCtrl'})
                        .otherwise({redirectTo: '/'});
            });
            app.factory('PostFactory', function ($http, $q, $timeout) {
                var factory = {
                    posts: false,
                    getPosts: function () {
                        var deferred = $q.defer();
                        $http.get('posts.json').
                                success(function (data) {
                                    factory.posts = data;
                                    $timeout(function () {
                                        deferred.resolve(factory.posts);
                                    }, 2000);
                                }).
                                error(function () {
                                    deferred.reject('Impossible de récupérer les articles');
                                });
                        return deferred.promise;
                    },
                    getPost: function (id) {
                        var post = {};
                        var deferred = $q.defer();
                        var posts = factory.getPosts().then(function (posts) {
                            angular.forEach(posts, function (value, key) {
                                if (value.id === id) {
                                    post = value;
                                }
                            });
                            deferred.resolve(post);
                        }, function (msg) {
                            alert(msg);
                        });
                        return deferred.promise;
                    }
                }
                return factory;
            });
            app.controller('PostsCtrl', function ($scope, PostFactory) {
                $scope.loading = true;
                $scope.posts = PostFactory.getPosts().then(function (posts) {
                    $scope.loading = false;
                    $scope.posts = posts;
                }, function (msg) {
                    alert(msg);
                });
            });
            app.controller('CommentsCtrl', function ($scope, PostFactory, $routeParams) {
                $scope.loading = true;
                var post = PostFactory.getPost(parseInt($routeParams.id, 10)).then(function (post) {
                    $scope.loading = false;
                    $scope.title = post.name;
                    $scope.comments = post.comments;
                }, function(msg){
                    alert(msg);
                });
            });</script>
    </head>
    <body ng-app="myApp">
        <div ng-view></div>
    </body>
</html>
